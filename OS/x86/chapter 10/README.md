# Chapter 10 32位x86处理器编程架构

## IA-32架构的基本执行环境

### 寄存器的扩展

为了在汇编语言程序中使用经过扩展的寄存器，需要给它们命令，它们的名字分别是前面的寄存器加个`E`。32位通用寄存器的高16位是不可独立使用的，但为了兼容性，可以单独使用低16位。

在32位模式下，为了生成32位物理地址，处理器需要使用32位的指令指针寄存器。为此，32位扩展了`IP`为`EIP`.

在32位模式下，对内存的访问从理论上来说不需要进行分段，因为本身有32根地址线，可以自由访问内存任何一个位置。但是，IA-32架构的处理器是基于分段模型的，仍然需要分段访问。但是，其也提供了一种变通的方案，即只分一个段，即平坦模型。

每个程序都有属于自己的内存空间。在16位模式下，一个程序可以自由地访问不属于它的内存位置，甚至可以对那些地方的内容进行修改。在32位模式下，处理器要求在加载程序时，先定义该程序所拥有的段，然后允许使用这些段。定义段时，除了基地址外，还附加了段界限、特权级别、类型等属性。

在32位模式下，传统的段寄存器，保存的不再是16位段基地址，而是段的选择子，即，用于选择所用访问的段，因此，严格来说，它的新名字叫做段选择器。每个段寄存器还包括一个不可见的部分，成为描述符高级缓存器。

### 基本的工作模式

1982年，Intel公司推出了80286处理器，第一次提出了保护模式的概念。在保护模式下，段寄存器中保存的不再是段地址，而是段选择子，真正的段地址位于段寄存器的描述符高速缓存中，是24位的。80286处理器访问内存时，不再需要将段地址左移。这样一来，段地址可以位于内存空间的任一位置。

80836,以及所有后续的32位处理器都兼容实模式，可以运行实模式下的8086程序，且在刚加电时，这些处理器都自动处于实模式下，只有在经过设置后，才能运行在保护模式下。

### 线性地址

除了分段的方式，IA-32也提供了分页的方式。

## 现代处理器的结构和特点

### 流水线

在8086时代，处理器就已经有了指令预取队列。当指令执行时，如果总线是空闲的，就可以在指令执行的同时预取指令并提前译码。

为了提高处理器的执行效率和速度，可以把一条指令分解成若干个细小的步骤，并分配给相应的单元完成。各个单元的执行是独立的、并行的。如此一来，各个步骤的执行在时间上就会重叠起来，这种执行指令的方法就是流水线技术。

### 高速缓存

局部性原理

### 乱序执行

为了实现流水线技术，需要将指令拆分成更小的可独立执行部分，即拆分为微操作。

有些指令特别简单，因此只需要一个微操作，如：

```asm
add eax, ebx
```

再比如：`add eax, [mem]`可以拆分为两个微操作，一个是用于从内存中读取数据并保存到临时寄存器，另一个用于将EAX寄存器和临时寄存器中的数值相加。

一旦将指令拆分为微操作，处理器就可以在必要的时候乱序执行程序：

```asm
mov eax, [mem1]
shl eax, 5
add eax, [mem2]
mov [mem3], eax
```

在执行逻辑左移命令的同时，处理器可以提前从内存中读取`mem2`的内容
